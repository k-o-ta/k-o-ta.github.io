<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="referrer" content="no-referrer">

        <!-- Enable responsiveness on mobile devices-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <title>zeitwerkとProtocol Buffersの共存 | k-ota&#x27;s weblog</title>
<meta property="og:title" content="zeitwerkとProtocol Buffersの共存 | k-ota&#x27;s weblog" />
<meta name="twitter:title" content="zeitwerkとProtocol Buffersの共存 | k-ota&#x27;s weblog" />

        

        <meta property="og:site_name" content="k-ota&#x27;s weblog" />
        <meta property="og:url" content="https:&#x2F;&#x2F;k-ota.dev&#x2F;" />

        


        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://k-ota.dev/base.css" />
        <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro&display=swap" rel="stylesheet">
        <link href="https://k-ota.dev/fontawesome/fontawesome.css" rel="stylesheet">
        <link href="https://k-ota.dev/fontawesome/brands.css" rel="stylesheet">
        <link href="https://k-ota.dev/fontawesome/solid.css" rel="stylesheet">

        <link rel='icon' type='image/x-icon' href="https://k-ota.dev/favicon.ico" />

        

        <link rel="stylesheet" href="https://k-ota.dev/page.css" />

    </head>
    <body>
        <a href="#main" class="skip-link p-screen-reader-text">Skip to content</a>
        <header class="l-header">
            <h1 class="c-title p-title"><a href="https:&#x2F;&#x2F;k-ota.dev&#x2F;" class="p-title__link">k-ota&#x27;s weblog</a></h1>
            </header>

        <main id="main" class="l-main">
            
<article class="p-article">
    <header>
        <h1>zeitwerkとProtocol Buffersの共存</h1>
        <div>
            <div class="c-time">

                <time datetime="2022-02-05">
                    2022-02-05
                </time>
                
                 - (5 min read)
            </div>
        </div>
    </header>
    <div class="post-toc" id="post-toc">
        <h2 class="post-toc-title">Contents</h2>
        <div class="post-toc-content always-active">
            <nav id="TableOfContents">
                <ul>
                    
                    <li>
                        <a href="https://k-ota.dev/protobuf-with-zeitwerk/#やりたいこと" class="toc-link">
    やりたいこと
</a>
                        
                    </li>
                    
                    <li>
                        <a href="https://k-ota.dev/protobuf-with-zeitwerk/#前提" class="toc-link">
    前提
</a>
                        
                    </li>
                    
                    <li>
                        <a href="https://k-ota.dev/protobuf-with-zeitwerk/#普通に使ってみる" class="toc-link">
    普通に使ってみる
</a>
                        
                    </li>
                    
                    <li>
                        <a href="https://k-ota.dev/protobuf-with-zeitwerk/#zeitwerk環境でも読み込めるようにする" class="toc-link">
    zeitwerk環境でも読み込めるようにする
</a>
                        
                    </li>
                    
                    <li>
                        <a href="https://k-ota.dev/protobuf-with-zeitwerk/#再読み込みを可能にする" class="toc-link">
    再読み込みを可能にする
</a>
                        
                    </li>
                    
                </ul>
            </nav>
        </div>
    </div>
    <section id="js-article" class="p-article__body">
        
    <h2 id="やりたいこと">やりたいこと<a class="zola-anchor" href="#やりたいこと" aria-label="Anchor link for: やりたいこと"><i class="fas fa-link"></i></a> 
</h2>
<ul>
<li>railsでzeitwerkを有効にしつつProtocolBuffersを利用したい</li>
</ul>
<h2 id="前提">前提<a class="zola-anchor" href="#前提" aria-label="Anchor link for: 前提"><i class="fas fa-link"></i></a> 
</h2>
<p>Protocol Buffersについての説明はしません</p>
<h2 id="普通に使ってみる">普通に使ってみる<a class="zola-anchor" href="#普通に使ってみる" aria-label="Anchor link for: 普通に使ってみる"><i class="fas fa-link"></i></a> 
</h2>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#65737e;"># Gemfile
</span><span style="color:#8fa1b3;">gem </span><span>&#39;</span><span style="color:#a3be8c;">google-protobuf</span><span>&#39;
</span></code></pre>
<pre data-lang="proto" style="background-color:#2b303b;color:#c0c5ce;" class="language-proto "><code class="language-proto" data-lang="proto"><span style="color:#65737e;">// proto/teacher.proto
</span><span style="color:#b48ead;">syntax </span><span>= &quot;</span><span style="color:#a3be8c;">proto3</span><span>&quot;;
</span><span>
</span><span style="color:#b48ead;">message </span><span style="color:#ebcb8b;">Teacher </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">  string </span><span style="color:#bf616a;">id </span><span>= </span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">  string </span><span style="color:#bf616a;">name </span><span>= </span><span style="color:#d08770;">2</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">}
</span></code></pre>
<p><code>.proto</code>からrubyのソースコードを生成する
<code>protoc --proto_path=protos --ruby_out=app/pb/ protos/*.proto</code> を実行すると、 <code>app/pb/teacher_pb.rb</code>に以下のようなファイルが生成されます。</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#65737e;"># Generated by the protocol buffer compiler.  DO NOT EDIT!
</span><span style="color:#65737e;"># source: teacher.proto
</span><span>
</span><span style="color:#8fa1b3;">require </span><span>&#39;</span><span style="color:#a3be8c;">google/protobuf</span><span>&#39;
</span><span>
</span><span style="color:#ebcb8b;">Google</span><span>::</span><span style="color:#ebcb8b;">Protobuf</span><span>::</span><span style="color:#ebcb8b;">DescriptorPool</span><span>.generated_pool.build </span><span style="color:#b48ead;">do
</span><span>  add_file(&quot;</span><span style="color:#a3be8c;">teacher.proto</span><span>&quot;, </span><span style="color:#a3be8c;">:syntax </span><span>=&gt; </span><span style="color:#a3be8c;">:proto3</span><span>) </span><span style="color:#b48ead;">do
</span><span>    add_message &quot;</span><span style="color:#a3be8c;">Teacher</span><span>&quot; </span><span style="color:#b48ead;">do
</span><span>      optional </span><span style="color:#a3be8c;">:id</span><span>, </span><span style="color:#a3be8c;">:string</span><span>, </span><span style="color:#d08770;">1
</span><span>      optional </span><span style="color:#a3be8c;">:name</span><span>, </span><span style="color:#a3be8c;">:string</span><span>, </span><span style="color:#d08770;">2
</span><span>    </span><span style="color:#b48ead;">end
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span><span>
</span><span>Teacher = ::</span><span style="color:#ebcb8b;">Google</span><span>::</span><span style="color:#ebcb8b;">Protobuf</span><span>::</span><span style="color:#ebcb8b;">DescriptorPool</span><span>.generated_pool.lookup(&quot;</span><span style="color:#a3be8c;">Teacher</span><span>&quot;).msgclass
</span></code></pre>
<p>これをそのまま使おうとすると失敗します。</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>% bin/rails c
</span><span>Loading development environment (Rails 7.0.2.2)
</span><span>irb(main):001:0&gt; Teacher
</span><span>(irb):1:in `&lt;main&gt;&#39;: uninitialized constant Teacher (NameError)
</span><span>Did you mean?  TeacherPb
</span><span>irb(main):002:0&gt; TeacherPb
</span><span>/home/.rbenv/versions/3.1.0/lib/ruby/gems/3.1.0/gems/zeitwerk-2.5.4/lib/zeitwerk/loader/callbacks.rb:25:in `on_file_autoloaded&#39;: expected file /home/development/rails-playground/app/pb/teacher_pb.rb to define constant TeacherPb, but didn&#39;t (Zeitwerk::NameError)
</span><span>
</span><span>      raise Zeitwerk::NameError.new(&quot;expected file #{file} to define constant #{cpath}, but didn&#39;t&quot;, cref.last)
</span><span>      ^^^^^
</span><span>irb(main):003:0&gt; Pb::Teacher
</span><span>(irb):3:in `&lt;main&gt;&#39;: uninitialized constant Pb (NameError)
</span></code></pre>
<h2 id="zeitwerk環境でも読み込めるようにする">zeitwerk環境でも読み込めるようにする<a class="zola-anchor" href="#zeitwerk環境でも読み込めるようにする" aria-label="Anchor link for: zeitwerk環境でも読み込めるようにする"><i class="fas fa-link"></i></a> 
</h2>
<p>理由や対応方法などは<a href="https://qiita.com/moonstruckdrops@github/items/ad467f3149e0154b5b61">Rails6でProtocol Buffersを使用する</a>がわかりやすいです。記事に習ってinflectorを追加してみましょう。</p>
<p>-- 記事から抜粋 --</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">WithProtobufInflector </span><span style="color:#eff1f5;">&lt; </span><span style="color:#a3be8c;">Zeitwerk::Inflector
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">camelize</span><span>(</span><span style="color:#bf616a;">basename</span><span>, </span><span style="color:#bf616a;">abspath</span><span>)
</span><span>    </span><span style="color:#b48ead;">if</span><span> basename =~ /</span><span style="color:#96b5b4;">\A.*_pb$</span><span>/
</span><span>      basename.</span><span style="color:#96b5b4;">gsub</span><span>(&quot;</span><span style="color:#a3be8c;">_pb</span><span>&quot;, &#39;&#39;).camelize
</span><span>    </span><span style="color:#b48ead;">else
</span><span>      </span><span style="color:#b48ead;">super
</span><span>    </span><span style="color:#b48ead;">end
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span><span>
</span><span style="color:#ebcb8b;">Rails</span><span>.autoloaders.each </span><span style="color:#b48ead;">do </span><span>|</span><span style="color:#bf616a;">autoloader</span><span>|
</span><span>  autoloader.inflector = </span><span style="color:#ebcb8b;">WithProtobufInflector</span><span>.</span><span style="color:#8fa1b3;">new
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>-- 記事から抜粋(終わり) --</p>
<p>うまくいきました。</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>% bin/rails c
</span><span>Loading development environment (Rails 7.0.2.2)
</span><span>irb(main):001:0&gt; Teacher.new(name: &#39;foo&#39;)
</span><span>=&gt; &lt;Teacher: id: &quot;&quot;, name: &quot;foo&quot;&gt;
</span></code></pre>
<p>これをcontrollerに組み込んでも普通に使えます。</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">WelcomeController </span><span style="color:#eff1f5;">&lt; </span><span style="color:#a3be8c;">ApplicationController
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">index
</span><span>    @</span><span style="color:#bf616a;">teacher </span><span>= </span><span style="color:#ebcb8b;">Teacher</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#a3be8c;">name: </span><span>&#39;</span><span style="color:#a3be8c;">foo</span><span>&#39;)
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>しかし、controllerを変更するなどしてrails再読み込みが発生すると<code>Unable to build file to DescriptorPool: duplicate file name (teacher.proto)</code>というエラーが発生する</p>
<h2 id="再読み込みを可能にする">再読み込みを可能にする<a class="zola-anchor" href="#再読み込みを可能にする" aria-label="Anchor link for: 再読み込みを可能にする"><i class="fas fa-link"></i></a> 
</h2>
<p>これはファイルの変更時にzeitwerkのreloadingが走っていることが原因です。これをを防ぐためにはprotobuf部分を外部gem化すると良いです。
<a href="https://github.com/fxn/zeitwerk#reloading">zeitwerkのドキュメント</a>にあるように、一般的にGemはreloadingをする必要がなく、zeitwerkのデフォルトの設定でもreloadingは無効になっています。</p>
<blockquote>
<p>Gems that implement regular libraries, so to speak, or services running in testing or production environments, won't normally have a use case for reloading.</p>
</blockquote>
<p>gemの作成</p>
<p><code>bundle gem k_ota_schema_registry</code></p>
<p>他の言語からも使われることを想定して、ruby独自の部分はサブディレクトリに移しておく</p>
<p><code>cd k_ota_schema_registry</code></p>
<p><code>mkdir -p protos/k_ota_schema_registry ruby</code> (rubyのgemのdirectory構造に合わせて出力できるようにprotoを置くディレクトリを作っておく)</p>
<p><code>mv bin lib Gemfile k_ota_schema_registry.gemspec Rakefile ruby</code></p>
<p>protocコマンドは対象となるprotoファイルを一つずつ指定する必要があるので、rakeタスクで一括生成できるようにしておく</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#65737e;"># ruby/Rakefile
</span><span>
</span><span style="color:#8fa1b3;">require </span><span>&quot;</span><span style="color:#a3be8c;">bundler/gem_tasks</span><span>&quot;
</span><span>task </span><span style="color:#a3be8c;">default: </span><span>&#39;</span><span style="color:#a3be8c;">protobuf:generate</span><span>&#39;
</span><span>
</span><span>namespace </span><span style="color:#a3be8c;">:protobuf </span><span style="color:#b48ead;">do
</span><span>  desc &#39;</span><span style="color:#a3be8c;">generate ruby file</span><span>&#39;
</span><span>  task </span><span style="color:#a3be8c;">:generate </span><span style="color:#b48ead;">do
</span><span>    protofiles = </span><span style="color:#ebcb8b;">Dir</span><span>.glob(&#39;</span><span style="color:#a3be8c;">protos/**/*.proto</span><span>&#39;, </span><span style="color:#a3be8c;">base: </span><span>&#39;</span><span style="color:#a3be8c;">..</span><span>&#39;)
</span><span>    </span><span style="color:#96b5b4;">system</span><span>([&#39;</span><span style="color:#a3be8c;">protoc --proto_path=protos --ruby_out=ruby/lib</span><span>&#39;, *protofiles].join(&#39; &#39;), </span><span style="color:#a3be8c;">chdir: </span><span>&#39;</span><span style="color:#a3be8c;">..</span><span>&#39;)
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>また、<a href="https://k-ota.dev/protobuf-with-zeitwerk/#zeitwerk%E7%92%B0%E5%A2%83%E3%81%A7%E3%82%82%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%81%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B">zeitwerk環境でも読み込めるようにした</a>ように、zeitwerk対応を入れる。<a href="https://github.com/fxn/zeitwerk#custom-inflector">README</a>の構造に、先程のzeitwerk対応のコードを入れれば良い。</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#65737e;"># ruby/lib/k_ota_schema_registry.rb
</span><span>
</span><span style="color:#8fa1b3;">require </span><span>&quot;</span><span style="color:#a3be8c;">zeitwerk</span><span>&quot;
</span><span style="color:#8fa1b3;">require_relative </span><span>&quot;</span><span style="color:#a3be8c;">k_ota_schema_registry/inflector</span><span>&quot;
</span><span>
</span><span>loader = </span><span style="color:#ebcb8b;">Zeitwerk</span><span>::</span><span style="color:#ebcb8b;">Loader</span><span>.for_gem
</span><span>loader.inflector = </span><span style="color:#ebcb8b;">KOtaSchemaRegistry</span><span>::</span><span style="color:#ebcb8b;">Inflector</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#bf616a;">__FILE__</span><span>)
</span><span>loader.setup
</span><span>
</span><span style="color:#b48ead;">module </span><span>KOtaSchemaRegistry
</span><span>  </span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Error </span><span style="color:#eff1f5;">&lt; </span><span style="color:#a3be8c;">StandardError</span><span>; </span><span style="color:#b48ead;">end
</span><span>  </span><span style="color:#65737e;"># Your code goes here...
</span><span style="color:#b48ead;">end
</span><span>
</span><span style="color:#65737e;"># ruby/lib/k_ota_schema_registry/inflector.rb
</span><span style="color:#b48ead;">module </span><span>KOtaSchemaRegistry
</span><span>  </span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Inflector </span><span style="color:#eff1f5;">&lt; </span><span style="color:#a3be8c;">Zeitwerk::GemInflector
</span><span>    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">camelize</span><span>(</span><span style="color:#bf616a;">basename</span><span>, </span><span style="color:#bf616a;">abspath</span><span>)
</span><span>      </span><span style="color:#b48ead;">if</span><span> basename =~ /</span><span style="color:#96b5b4;">\A.*_pb$</span><span>/
</span><span>        basename.</span><span style="color:#96b5b4;">gsub</span><span>(&quot;</span><span style="color:#a3be8c;">_pb</span><span>&quot;, &#39;&#39;).camelize
</span><span>      </span><span style="color:#b48ead;">else
</span><span>        </span><span style="color:#b48ead;">super
</span><span>      </span><span style="color:#b48ead;">end
</span><span>    </span><span style="color:#b48ead;">end
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>利用する側は素直にgemfileとして使える</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#65737e;"># Gemfile
</span><span style="color:#8fa1b3;">gem </span><span>&#39;</span><span style="color:#a3be8c;">k_ota_schema_registry</span><span>&#39;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">git: </span><span>&#39;</span><span style="color:#a3be8c;">https://github.com/k-o-ta/k_ota_schema_registry.git</span><span>&#39;</span><span style="color:#8fa1b3;">, </span><span style="color:#a3be8c;">branch: </span><span>&#39;</span><span style="color:#a3be8c;">main</span><span>&#39;
</span></code></pre>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>% bin/rails c
</span><span>Loading development environment (Rails 7.0.2.2)
</span><span>irb(main):002:0&gt; KOtaSchemaRegistry::Teacher.new(id: &#39;1&#39;, name: &#39;foo&#39;)
</span><span>=&gt; &lt;KOtaSchemaRegistry::Teacher: id: &quot;1&quot;, name: &quot;foo&quot;&gt;
</span><span>irb(main):003:0&gt; KOtaSchemaRegistry::Foo::Student.new(id: &#39;1&#39;, name: &#39;bar&#39;)
</span><span>=&gt; &lt;KOtaSchemaRegistry::Foo::Student: id: &quot;1&quot;, name: &quot;bar&quot;&gt;
</span><span>irb(main):004:0&gt; reload!
</span><span>Reloading...
</span><span>=&gt; true
</span><span># reloadしても問題ない
</span><span>irb(main):005:0&gt; KOtaSchemaRegistry::Foo::Student.new(id: &#39;1&#39;, name: &#39;bar&#39;)
</span><span>=&gt; &lt;KOtaSchemaRegistry::Foo::Student: id: &quot;1&quot;, name: &quot;bar&quot;&gt;
</span></code></pre>


    </section>
    <footer>
        <nav class="c-pagination p-pagination">
            <div class="c-pagination__ctrl">
                <div class="c-pagination__newer">
                    
                </div>
                <div class="c-pagination__older">
                    
                </div>
            </div>
        </nav>
    </footer>
</article>
        </main>

     
      <footer class="l-footer">
          
        <p class="tags">
              
                  
                  <span><a href="https://k-ota.dev/tags/ruby-on-rails/">Ruby on Rails</a></span>
              
                  
                  <span><a href="https://k-ota.dev/tags/protocol-buffers/">Protocol Buffers</a></span>
              
            </p>
    
<p class="p-copyright">
    
</p>
      </footer>

      <!-- Global site tag (gtag.js) - Google Analytics -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-172917470-1"></script>
      <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-172917470-1');
      </script> 
      <link rel="stylesheet" href="https://k-ota.dev/css/katex.min.css">
      <script defer src="https://k-ota.dev/js/katex.min.js"></script>
      <script defer src="https://k-ota.dev/js/mathtex-script-type.min.js"></script>
    </body>
</html>
            
