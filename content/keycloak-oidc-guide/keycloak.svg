<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="728px" preserveAspectRatio="none" style="width:1476px;height:728px;" version="1.1" viewBox="0 0 1476 728" width="1476px" zoomAndPan="magnify"><defs><filter height="300%" id="f12jvp9ar6lpzd" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[4a65e84059005d12693a083370a06717]
entity client--><rect fill="#FFD700" filter="url(#f12jvp9ar6lpzd)" height="111.4844" style="stroke: #A80036; stroke-width: 1.5;" width="334" x="621.032" y="8"/><rect fill="#FFD700" height="10" style="stroke: #A80036; stroke-width: 1.5;" width="15" x="935.032" y="13"/><rect fill="#FFD700" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="933.032" y="15"/><rect fill="#FFD700" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="933.032" y="19"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="755.032" y="40.9951">«entity»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="636.032" y="57.292">client</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="196" x="636.032" y="73.5889">アプリケーションとも言われる</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="294" x="636.032" y="89.8857">認証/認可するアプリケーションごとに1つ作る</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="63" x="636.032" y="106.1826">&gt; Clients</text><!--MD5=[d0af60a9e4522d7a2524e7d8b84568aa]
entity protocol_mapper--><rect fill="#FEFECE" filter="url(#f12jvp9ar6lpzd)" height="144.0781" style="stroke: #A80036; stroke-width: 1.5;" width="363" x="443.532" y="401"/><rect fill="#FEFECE" height="10" style="stroke: #A80036; stroke-width: 1.5;" width="15" x="786.532" y="406"/><rect fill="#FEFECE" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="784.532" y="408"/><rect fill="#FEFECE" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="784.532" y="412"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="115" x="458.532" y="433.9951">protocol-mapper</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="143" x="458.532" y="450.292">&gt; Clients &gt; Mappers</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="323" x="458.532" y="466.5889">どのデータをOIDCのtokenやOAuth2に入れるかを</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="458.532" y="482.8857">設定する</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="213" x="458.532" y="499.1826">clietやuserのデータをどのように</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="310" x="458.532" y="515.4795">OIDCやSMALといったプロトコルに反映するかを</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="213" x="458.532" y="531.7764">決めているのでprotocol-mapper</text><!--MD5=[e0a731e2a746c9a525baeff4c3ac8e0b]
entity role_scope_mapping--><rect fill="#FEFECE" filter="url(#f12jvp9ar6lpzd)" height="111.4844" style="stroke: #A80036; stroke-width: 1.5;" width="374" x="35.0317" y="417.5"/><rect fill="#FEFECE" height="10" style="stroke: #A80036; stroke-width: 1.5;" width="15" x="389.0317" y="422.5"/><rect fill="#FEFECE" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="387.0317" y="424.5"/><rect fill="#FEFECE" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="387.0317" y="428.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="139" x="50.0317" y="450.4951">role-scope-mapping</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="50.0317" y="466.792">&gt; Clients &gt; Scope</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="279" x="50.0317" y="483.0889">user-role-mappingの情報はtokenに表れる</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="334" x="50.0317" y="499.3857">tokenを不正に取得されたときに悪用されないように</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="262" x="50.0317" y="515.6826">tokenに含められるroleの情報を制限する</text><!--MD5=[39ea7aab0b6aa652577bc2c5144c3f31]
entity client_client_scope--><rect fill="#FEFECE" filter="url(#f12jvp9ar6lpzd)" height="78.8906" style="stroke: #A80036; stroke-width: 1.5;" width="260" x="54.0317" y="220.5"/><rect fill="#FEFECE" height="10" style="stroke: #A80036; stroke-width: 1.5;" width="15" x="294.0317" y="225.5"/><rect fill="#FEFECE" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="292.0317" y="227.5"/><rect fill="#FEFECE" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="292.0317" y="231.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="69.0317" y="253.4951">client-client-scope</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="178" x="69.0317" y="269.792">&gt; Clients &gt; Client Scopes</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="220" x="69.0317" y="286.0889">clientとclient-scopeを結びつける</text><!--MD5=[532115b7fcf3d45105a1955f5c308858]
entity service_account--><rect fill="#FFD700" filter="url(#f12jvp9ar6lpzd)" height="160.375" style="stroke: #A80036; stroke-width: 1.5;" width="469" x="912.532" y="180"/><rect fill="#FFD700" height="10" style="stroke: #A80036; stroke-width: 1.5;" width="15" x="1361.532" y="185"/><rect fill="#FFD700" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="1359.532" y="187"/><rect fill="#FFD700" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="1359.532" y="191"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="1114.032" y="212.9951">«entity»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="110" x="927.532" y="229.292">service-account</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="339" x="927.532" y="245.5889">&gt; Clients &gt; Settings &gt; Service Accounts Enabled</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="429" x="927.532" y="261.8857">clientに属するアクセストークンを取得する仕組み(内部的にはUser)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="317" x="927.532" y="278.1826">アクセストークンを取得してrest apiを呼び出せる</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="365" x="927.532" y="294.4795">ユーザーなのでuser-role-mappingで権限管理できるが、</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="182" x="927.532" y="310.7764">サービスアカウントの場合は</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="297" x="927.532" y="327.0732">&gt; Clients &gt; Service Account Roles から行う</text><!--MD5=[f1dae809e2651fdddeda9a5ebb5c8639]
entity client_scope--><rect fill="#FEFECE" filter="url(#f12jvp9ar6lpzd)" height="144.0781" style="stroke: #A80036; stroke-width: 1.5;" width="385" x="349.532" y="188"/><rect fill="#FEFECE" height="10" style="stroke: #A80036; stroke-width: 1.5;" width="15" x="714.532" y="193"/><rect fill="#FEFECE" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="712.532" y="195"/><rect fill="#FEFECE" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="712.532" y="199"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="364.532" y="220.9951">client-scope</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="111" x="364.532" y="237.292">&gt; Client Scopes</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="149" x="364.532" y="253.5889">clientが複数ある場合に</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="345" x="364.532" y="269.8857">protocol-mapperとrole-scope-mapperをそれぞれに</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="210" x="364.532" y="286.1826">設定するのが面倒だったりする。</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="331" x="364.532" y="302.4795">client_scopeで共通の設定を作っておき、cient間で</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="364.532" y="318.7764">使い回せる</text><!--MD5=[e753409e3a4de609e6aed690c35e546b]
entity role--><rect fill="#FFD700" filter="url(#f12jvp9ar6lpzd)" height="111.4844" style="stroke: #A80036; stroke-width: 1.5;" width="296" x="1169.03" y="417.5"/><rect fill="#FFD700" height="10" style="stroke: #A80036; stroke-width: 1.5;" width="15" x="1445.03" y="422.5"/><rect fill="#FFD700" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="1443.03" y="424.5"/><rect fill="#FFD700" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="1443.03" y="428.5"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="1284.03" y="450.4951">«entity»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="26" x="1184.03" y="466.792">role</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="1184.03" y="483.0889">&gt; Roles</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="250" x="1184.03" y="499.3857">roleはユーザーの属性を表すだけでなく</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="256" x="1184.03" y="515.6826">keyclaok内の権限を意味することもある</text><!--MD5=[93fe6184315f41f41017de5464307f3f]
entity realm_role--><rect fill="#FFD700" filter="url(#f12jvp9ar6lpzd)" height="78.8906" style="stroke: #A80036; stroke-width: 1.5;" width="201" x="1158.53" y="630"/><rect fill="#FFD700" height="10" style="stroke: #A80036; stroke-width: 1.5;" width="15" x="1339.53" y="635"/><rect fill="#FFD700" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="1337.53" y="637"/><rect fill="#FFD700" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="1337.53" y="641"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="1226.03" y="662.9951">«entity»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="68" x="1173.53" y="679.292">realm role</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="161" x="1173.53" y="695.5889">&gt; Roles &gt; Realm Roles</text><!--MD5=[46259f2d18fd6a2f843b3dafbe6921f4]
entity client_role--><rect fill="#FFD700" filter="url(#f12jvp9ar6lpzd)" height="78.8906" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="942.032" y="630"/><rect fill="#FFD700" height="10" style="stroke: #A80036; stroke-width: 1.5;" width="15" x="1084.032" y="635"/><rect fill="#FFD700" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="1082.032" y="637"/><rect fill="#FFD700" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="1082.032" y="641"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="990.032" y="662.9951">«entity»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="67" x="957.032" y="679.292">client role</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="122" x="957.032" y="695.5889">&gt; Clients &gt; Roles</text><!--MD5=[8fc3522a43f8c7199df5e09e5bb0188e]
entity user--><rect fill="#FFD700" filter="url(#f12jvp9ar6lpzd)" height="78.8906" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="1315.03" y="24"/><rect fill="#FFD700" height="10" style="stroke: #A80036; stroke-width: 1.5;" width="15" x="1391.03" y="29"/><rect fill="#FFD700" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="1389.03" y="31"/><rect fill="#FFD700" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="1389.03" y="35"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="56" x="1330.03" y="56.9951">«entity»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="1330.03" y="73.292">user</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="1330.03" y="89.5889">&gt; Users</text><!--MD5=[d6194f9d6b81dbed40a9bc8dd24d0dd3]
entity user_role_mapping--><rect fill="#FEFECE" filter="url(#f12jvp9ar6lpzd)" height="95.1875" style="stroke: #A80036; stroke-width: 1.5;" width="222" x="912.032" y="425.5"/><rect fill="#FEFECE" height="10" style="stroke: #A80036; stroke-width: 1.5;" width="15" x="1114.032" y="430.5"/><rect fill="#FEFECE" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="1112.032" y="432.5"/><rect fill="#FEFECE" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="1112.032" y="436.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="927.032" y="458.4951">user-role-mapping</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="178" x="927.032" y="474.792">&gt; Users &gt; Role Mappings</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="182" x="927.032" y="491.0889">ユーザーの属性やそれによる</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="927.032" y="507.3857">権限を設定する</text><!--MD5=[72484008a7d8bd24a59a3e5ab0f40c90]
entity token--><rect fill="#BDB76B" filter="url(#f12jvp9ar6lpzd)" height="95.1875" style="stroke: #A80036; stroke-width: 1.5;" width="391" x="429.532" y="622"/><rect fill="#BDB76B" height="10" style="stroke: #A80036; stroke-width: 1.5;" width="15" x="800.532" y="627"/><rect fill="#BDB76B" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="798.532" y="629"/><rect fill="#BDB76B" height="2" style="stroke: #A80036; stroke-width: 1.5;" width="4" x="798.532" y="633"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="75" x="582.532" y="654.9951">«protocol»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="444.532" y="671.292">token</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="351" x="444.532" y="687.5889">OIDCやOAuth2上で認証/認可の結果得られる情報(JWT)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="145" x="444.532" y="703.8857">OIDCなどはこのtoken</text><!--MD5=[4dc33f9adddae4c74248efe979739359]
reverse link role to realm_role--><path d="M1294.98,547.936 C1286.66,575.86 1277.52,606.508 1270.54,629.916 " fill="none" id="role&lt;-realm_role" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="none" points="1288.3,545.862,1300.72,528.697,1301.71,549.863,1288.3,545.862" style="stroke: #A80036; stroke-width: 1.0;"/><!--MD5=[ba454497c33384d5dfab59963c2ec7e1]
reverse link role to client_role--><path d="M1217.38,539.928 C1172.12,569.87 1120.16,604.246 1081.35,629.916 " fill="none" id="role&lt;-client_role" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="none" points="1213.81,533.894,1234.35,528.697,1221.54,545.57,1213.81,533.894" style="stroke: #A80036; stroke-width: 1.0;"/><!--MD5=[f45aed736d4433ee119e9b92791b0276]
link client to client_role--><path d="M808.023,119.159 C811.276,129.02 814.427,139.261 817.032,149 C863.355,322.209 808.133,387.619 894.032,545 C909.953,574.171 935.157,600.565 959.079,621.3935 " fill="none" id="client-&gt;client_role" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="969.222,629.9711,967.2235,623.0425,960.0591,622.2224,962.0577,629.151,969.222,629.9711" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="802.1718" y="139.6893">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="951.2859" y="618.9756">n</text><!--MD5=[d55a8e7d209b2c5662c12ff20b71542b]
link client to protocol_mapper--><path d="M790.715,119.102 C791.372,176.821 786.091,269.134 752.032,340 C743.387,357.987 731.349,375.087 718.101,390.655 " fill="none" id="client-&gt;protocol_mapper" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="709.244,400.658,716.2162,398.8173,717.1987,391.6734,710.2265,393.5141,709.244,400.658" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="782.538" y="139.6246">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="709.1399" y="389.8681">1</text><!--MD5=[71908b30f1be2407bcaa13cc2efc8d84]
reverse link client to role_scope_mapping--><path d="M607.64,66.229 C409.043,72.411 108.224,95.873 36.0317,180 C-10.2776,233.965 3.396,276.82 36.0317,340 C52.3872,371.663 80.2316,397.377 109.465,417.412 " fill="none" id="client&lt;-role_scope_mapping" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FFFFFF" points="620.867,65.838,614.7514,62.0171,608.8722,66.1927,614.9879,70.0136,620.867,65.838" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="605.1111" y="62.663">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="86.5302" y="406.3732">1</text><!--MD5=[beedef60d3359295494c99b18e5cf9b4]
link role_scope_mapping to user_role_mapping--><path d="M318.321,417.39 C356.084,398.578 400.598,379.952 443.532,370.5 C535.55,350.241 777.282,343.431 867.532,370.5 C904.077,381.461 939.97,404.095 968.048,425.312 " fill="none" id="role_scope_mapping-user_role_mapping" style="stroke: #A80036; stroke-width: 1.0;"/><!--MD5=[28d190d6e402388738f0d580b721cbaf]
reverse link client to service_account--><path d="M900.553,125.462 C932.37,142.7 967.465,161.714 1000.951,179.856 " fill="none" id="client&lt;-service_account" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FFFFFF" points="888.989,119.197,892.3589,125.5722,899.5399,124.9135,896.17,118.5383,888.989,119.197" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="894.0176" y="139.7324">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="979.1154" y="168.832">1</text><!--MD5=[d1ca81c1192226635ea4317497dcd83d]
reverse link client to client_client_scope--><path d="M608.212,99.477 C522.995,118.709 420.687,145.697 332.032,180 C303.51,191.036 273.488,206.309 247.993,220.487 " fill="none" id="client&lt;-client_client_scope" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FFFFFF" points="620.927,96.636,614.199,94.0411,609.216,99.2535,615.944,101.8485,620.927,96.636" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="605.1738" y="94.8566">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="250.2988" y="209.4943">n</text><!--MD5=[83af2e1c58d20618e74cb7c49075df6b]
link client_client_scope to client_scope--><path d="M314.086,260 C325.81,260 337.534,260 349.258,260 " fill="none" id="client_client_scope-client_scope" style="stroke: #A80036; stroke-width: 1.0;"/><!--MD5=[7978ae4375660b8d07ed03640a7aa79a]
reverse link client_scope to protocol_mapper--><path d="M574.785,344.265 C582.143,362.969 589.885,382.65 597.028,400.809 " fill="none" id="client_scope&lt;-protocol_mapper" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FFFFFF" points="570.016,332.141,568.49,339.1888,574.4087,343.3081,575.9347,336.2603,570.016,332.141" style="stroke: #A80036; stroke-width: 1.0;"/><!--MD5=[ff219158acf6bdab15e4c11bee80efc4]
reverse link client_scope to role_scope_mapping--><path d="M423.153,339.386 C383.832,365.313 340.957,393.584 304.934,417.337 " fill="none" id="client_scope&lt;-role_scope_mapping" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FFFFFF" points="434.14,332.141,426.929,332.1043,424.1216,338.7465,431.3327,338.7832,434.14,332.141" style="stroke: #A80036; stroke-width: 1.0;"/><!--MD5=[536ac05d96daeda7f2cee8bf2621d53d]
reverse link user to user_role_mapping--><path d="M1389.71,115.245 C1417.22,175.382 1449.56,275.537 1399.03,340 C1329.01,429.334 1256.7,359.551 1151.03,401 C1133.76,407.774 1115.93,416.458 1099.27,425.412 " fill="none" id="user&lt;-user_role_mapping" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FFFFFF" points="1384.13,103.41,1383.0741,110.5434,1389.2526,114.2617,1390.3085,107.1283,1384.13,103.41" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="1378.8553" y="123.0522">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="1101.88" y="414.3838">1</text><!--MD5=[b427a3c4c93ceff0c38b4fb928a0cc3b]
reverse link user to service_account--><path d="M1305.09,116.677 C1283.55,136.07 1258.6,158.533 1234.98,179.803 " fill="none" id="user&lt;-service_account" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="none" points="1300.55,111.341,1320.1,103.159,1309.92,121.744,1300.55,111.341" style="stroke: #A80036; stroke-width: 1.0;"/><!--MD5=[03b54a0bac41e6e38ee7618e432b6e62]
reverse link user_role_mapping to realm_role--><path d="M1089.78,529.012 C1128.8,561.167 1177.09,600.969 1212.09,629.816 " fill="none" id="user_role_mapping&lt;-realm_role" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FFFFFF" points="1079.56,520.588,1081.645,527.4911,1088.8191,528.2215,1086.734,521.3184,1079.56,520.588" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="1079.2751" y="540.7419">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="1195.3347" y="618.794">n</text><!--MD5=[04c3d5db22b39f45e2376bfae266556b]
reverse link user_role_mapping to client_role--><path d="M1023.03,533.995 C1023.03,565.203 1023.03,602.442 1023.03,629.816 " fill="none" id="user_role_mapping&lt;-client_role" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FFFFFF" points="1023.03,520.588,1019.03,526.588,1023.03,532.588,1027.03,526.588,1023.03,520.588" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="1014.4422" y="540.7419">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="1014.3422" y="618.794">n</text><!--MD5=[cafc473fb3b9d40be5c7c5dabd48288e]
link protocol_mapper to token--><path d="M625.032,545.045 C625.032,570.655 625.032,598.886 625.032,621.8796 " fill="none" id="protocol_mapper-token" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="626.032" y="588.0669">生成</text><polygon fill="#000000" points="634.532,597.1328,637.532,603.1328,640.532,597.1328,634.532,597.1328" style="stroke: #000000; stroke-width: 1.0;"/><!--MD5=[c1fab91b51577b5fc1f989e33c271bf8]
@startuml keycloak
component client <<entity>> [
    client
    アプリケーションとも言われる
    認証/認可するアプリケーションごとに1つ作る
    > Clients]
component protocol_mapper [
    protocol-mapper
    > Clients > Mappers
    どのデータをOIDCのtokenやOAuth2に入れるかを
    設定する
    clietやuserのデータをどのように
    OIDCやSMALといったプロトコルに反映するかを
    決めているのでprotocol-mapper
]
component role_scope_mapping [
    role-scope-mapping
    > Clients > Scope
    user-role-mappingの情報はtokenに表れる
    tokenを不正に取得されたときに悪用されないように
    tokenに含められるroleの情報を制限する
]

component client_client_scope [
    client-client-scope
    > Clients > Client Scopes
    clientとclient-scopeを結びつける
]

component service_account <<entity>> [
    service-account
    > Clients > Settings > Service Accounts Enabled 
    clientに属するアクセストークンを取得する仕組み(内部的にはUser)
    アクセストークンを取得してrest apiを呼び出せる
    ユーザーなのでuser-role-mappingで権限管理できるが、
    サービスアカウントの場合は
    > Clients > Service Account Roles から行う
]

component client_scope [
    client-scope
    > Client Scopes
    clientが複数ある場合に
    protocol-mapperとrole-scope-mapperをそれぞれに
    設定するのが面倒だったりする。
    client_scopeで共通の設定を作っておき、cient間で
    使い回せる
]

component role <<entity>>[
    role
    > Roles
    roleはユーザーの属性を表すだけでなく
    keyclaok内の権限を意味することもある
    ]
component realm_role <<entity>>[
    realm role
    > Roles > Realm Roles]
component client_role <<entity>>[
    client role
    > Clients > Roles]

component user <<entity>>[
    user
    > Users]
component user_role_mapping [
    user-role-mapping
    > Users > Role Mappings
    ユーザーの属性やそれによる
    権限を設定する
]

component token <<protocol>> [
    token
    OIDCやOAuth2上で認証/認可の結果得られる情報(JWT)
    OIDCなどはこのtoken
]

skinparam component {
    backgroundColor<<protocol>> DarkKhaki
    BackgroundColor<<entity>> gold
}

role <|- - realm_role
role <|- - client_role

client "1" - -* "n" client_role
client "1" - -* "1" protocol_mapper
client "1" o- - "1" role_scope_mapping
role_scope_mapping - user_role_mapping
client "1" o- - "1" service_account
client "1" o- - "n" client_client_scope

client_client_scope - client_scope
client_scope o- - protocol_mapper
client_scope o- - role_scope_mapping

user "1" o- - "1" user_role_mapping
user <|- - service_account
user_role_mapping "1" o- - "n" realm_role
user_role_mapping "1" o- - "n" client_role

protocol_mapper - - token : 生成 >

@enduml

PlantUML version 1.2019.13(Tue Dec 10 17:18:29 UTC 2019)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_232-b09
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>